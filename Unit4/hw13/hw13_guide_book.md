# 面向对象设计与构造第13次作业

## 第一部分：训练目标

本次作业以一个图书馆管理系统为背景，锻炼同学们**对程序架构的设计和抽象能力，以及UML建模能力**。

## 第二部分：预备知识

同学们需要掌握 **UML 图**的相关知识以及 **StarUML 的使用方法**。这里给出一些**参考资料**。

[第四单元手册](http://gitlab.oo.buaa.edu.cn/2024_oo_public/guidebook/homework_13)

同学亦可参阅OO工具链教程的文末部分：

[OO工具链教程](http://gitlab.oo.buaa.edu.cn/2024_oo_public/course_system_guidebook/-/blob/main/%E3%80%8A%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%9E%84%E9%80%A0%E3%80%8B%E5%B7%A5%E5%85%B7%E9%93%BE%E6%95%99%E7%A8%8B.md)

## 第三部分：题目描述

在一所小型图书馆中，用户借阅图书需要遵守一定的规章制度。我们需要你模拟一个小型的图书管理系统，完成图书馆所支持的相关业务。

图书馆里的所有图书按照 **“类别号-序列号”** 的形式编制**书号**（同学们可以理解为 ISBN 国际标准书号的简化形式，即一本书的书号是唯一的，它的所有副本的书号都是相同的）。图书分 A 、B 、C 三类，每种类别可能包含多个图书，每个图书可能具有多个副本（具有相同书号的两本书籍是同质的）。对于不同类别的书，有不同的借阅数量限制。

图书馆的运行分为两个时段：白天**开馆**，夜晚**闭馆**。开馆后，图书管理系统需要处理用户的**各种请求**，依据图书馆的**运行规则**决定是否批准用户的请求；同时，开馆时和闭馆时，图书馆内部依据需要**整理各部门的图书**，以满足接下来可能处理的各种请求。

在本次作业中，开馆时图书管理系统需要处理的请求包括：借书、还书、查询、预约和预约取书。

### 一、流程描述

**重要概念说明**：

- 本次作业中，我们规定书籍仅可以存在于如下四个位置：**书架**、**预约处**、**借还处**和**用户**。
- 图书馆系统提供**自助查询机**查询书籍状态。
- 图书馆开馆后接收用户请求，输出处理结果；开馆和闭馆整理图书时，输出图书的转运路径。

#### 借阅流程

若一位用户来到图书馆借阅某书籍，按照如下规则来进行处理：

1. 若欲借阅的书籍无余本在架，借阅失败；
2. 若欲借阅的书籍为 **A 类书籍**，借阅失败（ A 类图书无法借阅）；
3. 若欲借阅的书籍为 **B** **类或 C 类书籍**，该用户会前往**借还处**登记。**借还处**会检查该用户所持有的书籍数量是否**符合借阅数量限制**（见后）。若符合则借阅成功，该用户从此刻起持有该书；否则借阅失败，书籍被扣在**借还处**，借还处从此刻起持有该书；

#### 还书流程

若一位用户来到图书馆归还某书籍，则该用户会前往**借还处**，在本次作业中还书立即成功，从此刻起，借还处持有该书，用户不再持有该书。

#### 预约流程

若一位用户需要预约某书籍，则该用户需要前往**预约处**登记。

1. 该用户必须满足下述要求才可以预约成功：
   - 预约的书不是 A 类书（规定 A 类书无法预约）。
   - 若已经持有一本 B 类书，则无法再预约其他 B 类书。
   - 若已经持有**某书号**的 C 类书，则不能预约**该书号**的 C 类书。
   - 若当前**没有持有** **B 类书**，可以**预约任意数量的** **B 类书**（ B 类书只要求用户不可以持有两本及以上，但预约不算在其中）。
   - 若当前**没有持有某书号的 C 类书**，就可以**预约任意数量该书号的 C 类书**。
2. 预约后，图书馆可在当日闭馆后选择将书送至预约处，送至预约处的图书需要指定是为了满足哪个预约请求而送达的，具体输出格式见后。
3. 图书送至预约处后，若在**开馆后整理**中送达，则从**当日**起为该用户保留 **5** 天；若在**闭馆后整理**中送达，从**次日**起为该用户保留 **5** 天。在此期间，该书不能在整理流程中移动。第五天闭馆时，该书不再视作为该用户保留，视为预约失效。从次日起，预约该书的用户将无法取走该书，图书馆可对该书进行整理。例如1月1日开馆后送达，则1月5日闭馆后，该书不再为用户保留；1月1日闭馆后送达，则1月6日闭馆后，该书不再为用户保留。

#### 取书流程

用户只能去预约处取书。

若预约处存在一本为该用户保留的图书，且取书后该用户持有的书仍然满足借阅数量限制，则该用户取书成功，即刻起由用户持有该书。否则取书失败，书籍不发生移动。

#### 查询流程

若用户需要查询图书馆内在架书籍的信息，可前往**自助查询机**处查询：

- 某书号的书的在架**可直接借阅**余本数。

#### 整理流程

每次开馆和每次闭馆后，系统都有一次机会整理各处的图书，此时系统可以任意移动图书馆内的可在整理流程中移动的图书（整理的目的是为了满足请求，若系统认为没有整理图书的必要，也可以不移动图书）。

### 二、规则描述

#### 图书借阅数量限制

- A 类书：仅能在图书馆阅览，不能外借，不可预约。
- B 类书：一人同一时刻仅能持有一个 B 类书的副本。
- C 类书：对于每一个书号，一人同一时刻仅能持有一个具有该书号的书籍副本。

#### 图书移动限制

任何可以**引起图书位置变化**的操作，该书数量的变化**符合实际**（一次移动仅可以改变单一副本的位置，在本次作业中**任何时候图书总数不变**）。

具体的，此次作业中，可以引起图书位置变化的操作如下：

* 成功的借书：书架 -> 用户
* 失败的借书：书架 -> 借还处
* 用户取书：预约处 -> 用户
* 用户还书：用户 -> 借还处
* 整理时的图书转运：借还处，书架，预约处这三个位置中从一个位置到另一个位置

### 三、作业要求

本次作业需要同学们设计并实验一个符合上述情景描述的图书馆模拟系统。需要完成的内容分为两部分：

1. 设计程序架构，绘制并提交 **UML 类图**。
2. 根据所设计的架构进行编程实现，并提交**程序代码**。

在这里，我们建议同学们按照 **“设计程序架构->绘制 UML 类图->编程实现”** 的顺序完成作业，以达到对于程序架构的设计和抽象能力的训练。同时请注意，你的程序架构应和 UML 类图保持一致，更多评测要求详见本指导书第四部分。

## 第四部分：评测标准

### 程序评测

本单元对程序正确性的检查采用**交互式评测**。具体的，我们的测试数据点只给出**借书请求**，**预约请求**和**查询请求**，而**还书请求**与**取书请求**依据同学们的输出情况动态生成，以检测同学们的程序是否能够正确处理不同情况的请求。

* 评测机保证一定是针对拥有某书的相应用户来生成该书的还书请求。对每条成功的借书请求，**至多生成 1 条**对应的还书请求。
* 评测机保证一定是某个用户对某书的预约成功之后才生成该书的取书请求，但不确定该请求发出时相应的图书是否送达预约处。对每条预约请求，**至多生成 2 条**取书请求。


### 类图

类图的评测规则如下：

* R1：类图正确性基本检验
	* 类图中的所有元素，除 direction 为 return 的 UMLParameter ，UMLAssociation ，UMLAssociationEnd ，UMLGeneralization ，UMLInterfaceRealization 外，其余元素的 name 字段不能为空。
	* 不能含有重名的类。
	* 不能有循环继承。
	* 任何一个类或接口不能重复继承另外一个类或接口。
	* 接口的所有属性和方法均需要为 public 。
* R2：类图与程序一致性检验（类内部对应关系）（Class 正确性检验）
	* 类图与程序能互相找到名字相同的类。
	* 类图中每个类的属性：考察它们是否与程序中类的属性的**名字、可见性、类型**一致。
	* 类图中每个类的方法：考察它们是否与程序中类的方法的**名字、可见性、返回值类型**一致。
* R3：类图与程序一致性检验（类内部对应关系）（Interface 正确性检验）
	* 与 R2 中检测 class 的条目一致。
* R4：类图与程序一致性检验（类内部对应关系）（Enum 正确性检验）
	* 与 R2 中检测 class 的条目一致。
	* 额外的，类图中所定义的**枚举项**要求与代码中相应枚举类所定义**枚举项**名称相同，且是一一对应。
* R5：针对关系的类图与程序一致性检查
	* 类图中的**继承、实现、关联**关系应和代码实现中的关系保持一致，即同时存在或同时不存在。

关于 UML 类图和程序一致性的检查，有以下说明：

* 对于所提交的 UML 类图和所提交程序
	* 设类图中的设计单元集合为 MC ，程序中的实现单元集合为 CC
	* “单元”包括 class ，interface ，enum class
* 对于 MC 中任意一个单元 Ma
	* Ma 中属性个数或方法个数不少于 1
	* CC 中一定存在一个单元 Ca 与 Ma 相对应，且 Ma 中属性数目不少于 Ca 中属性数目的 60% ，同时 Ma 中方法数目不少于 Ca 中方法数目的 60%
* 对于 CC 中的任意一个单元 Ca
	* MC 中必然存在一个单元 Ma 与之相对应
* 对于 MC 中任意两个单元Ma和Mb的关系 Rab
	* CC 中必然有对应的两个单元 Ca 和 Cb ，且 Ca 和 Cb 同样具有相同的关系 Rab ，反之亦然

对于关联关系的补充说明：

* 在程序中，如若一个设计单元 Ca 的成员属性引用了设计单元 Cb ，我们认为 Ca 、Cb 之间存在关联关系。
* 在 UML 类图中的关联关系，既可以通过设计单元的属性引用隐式描述（属性类型是设计单元），也可以用 UMLAssociation 来显式描述。
* 建议在画图时，将重要的关联关系使用 UMLAssociation 进行描述，更便于理解设计单元之间的关系。

### **提示与注意**

**文件保存**

* 请将所绘制的类图保存在 uml.mdj 文件中，并放在提交的**根目录**下（比如说与通常存放 Java 源代码 src 文件夹同级），否则将导致评测失败。
* **请确保类图对应的 UMLModel 的 name 字段为 Model** ，否则会导致评测失败。

![pku3NnA.png](https://s21.ax1x.com/2024/05/17/pku3NnA.png)

**使用 UML 进行设计**

* 完成作业时应先做好相应的设计，绘制 UML 类图后再实现具体代码。当然，代码变化后可以回头更新 UML 图，但不应该在完成代码后直接照着代码来画 UML 图，那样就失去了设计建模的意义。
* 为了保证同学们写代码时的灵活性，在实现具体代码时，可以根据需要在代码中添加 UML 类图中未指明的**属性和方法**，但 UML 图中的属性和方法应在程序中进行实现，具体检查方法请见前文说明。**注意，不要为了画图方便刻意减少代码中类和方法的数量，也不要试图钻规则的空子，请同学们认真完成作业。**
* UML 建模工具一般都采用了模型和视图相分离的管理方式，即类图中看到的内容实际是对模型的观察。因此，在类图中简单删除一个要素并不一定导致模型发生变化。在完成本次作业过程中，建议同学们要注意阅读 mdj 代码检查各字段是否符合预期，例如检查是否存在仅删去视图未删去元素本身的情况。
* 对于 UML 类图中的方法参数，请保证其在 mdj 文件中的先后顺序与程序中的一致。另外，除了构造方法，每一个方法的 RETURN 类参数应有且仅有一个。

**公测与强测**

**关于公测与强测的图评测说明**：为保证公测与强测中的图评测存在一定的难度差异，现有说明如下：

- 公测与强测中的图评测检查项是**相同的**。
- 公测中对于**属性和方法的一致性，以及关联关系检查**，即使存在错误也**不会判错**，但会在**解释信息**中给出一个导致该错误的原因。
- **不会判错**也即它在公测中被视作是正确的，不会影响进入强测。但是在强测中，如若存在错误则会被视作未通过该检查项。
- 请同学们在公测中仔细查看解释信息，若全都显示“通过”，则表明该项检查项真正通过。
- 请不要过度依赖评测机，发现错误原因后及时修改同质 bug ，避免因超出无代价提交次数而扣分。

由于对于 UML 图的检查以及对于设计的评判较为复杂灵活，本评测仅为判断同学们设计合理的必要条件。即通过评测的 UML 图和程序在此次作业中即被认为通过，但不代表同学的设计和实现没有其它隐藏问题，也不代表就已经是十分优秀的设计。鼓励同学们在完成作业的基础上，进一步了解 UML 图更多规则，以及学习一些设计模式。

## 第五部分：输入输出

### 一、程序输入

程序输入由**两部分**组成：**图书馆初始书目信息**和**用户请求动态信息**。

输入第一行为一个正整数 n，代表图书馆中共有 n 种不同的图书。

接下来 n 行每行对应一种书的详细信息，格式为“**类别号-序列号 副本数**”，例如 "B-0001 10" 代表 B 类下序号为 0001 的书（即书号为B-0001的书）馆藏 10 个副本。序列号为**四位数字**。输入保证不存在相同的 “类别号-序列号”，不同类别号下可以存在相同的序列号，每个书号的书最多 10 个副本。

接下来若干行每行对应一条动态信息，格式为**"[YYYY-mm-dd] OPEN"**和**"[YYYY-mm-dd] CLOSE"**之间的若干条**"[YYYY-mm-dd] <学号> <操作> <类别号-序列号>"**，代表在日期为 [YYYY-mm-dd] 的当天，用户 <学号> 对图书 <类别号-序列号> 进行 <操作>，除开馆指令和闭馆指令，设评测给定的指令条数为m。

在评测数据中，所有请求指令都位于当日的开馆指令和闭馆指令之间，对于没有任何指令的日期，评测数据可能省略开闭馆指令。形式化的限制如下：
* 数据的所有指令时间严格不减（不可能出现时间倒流的情况）。
* 对于任意开馆指令 A ，存在且仅存在一条相同日期的闭馆指令 B ，且 B 位于 A 之后；对于任意闭馆指令 P ，存在且仅存在一条相同日期的开馆指令 Q ，且 Q 位于 P 之前。
* 对于任意请求指令 Q ，保证存在相同日期的开馆指令位于 Q 之前，保证存在相同日期的闭馆指令位于 Q 之后。

**具体的 <操作> 种类**：

- queried：查询。
- borrowed：借书。
- ordered：预约书。
- returned：还书。
- picked：取书。

对于借还书动态信息，输入保证已按时间先后顺序排序。也即同一日期的全部信息，可理解为按照输入出现的顺序依次从早到晚发生。 **在图书馆第1天开馆前**，图书馆的所有书本均位于**书架**上。

1≤n≤100，1≤m≤200。 所有输入事件在 [2024-01-01] 至 [2024-12-31] 之间发生，保证日期合法。

**输入信息展示如下**：

| 场景                   | 输入                                           |
| ---------------------- | ---------------------------------------------- |
| 图书馆开馆时输入       | "[YYYY-mm-dd] OPEN"                            |
| 图书馆闭馆时输入       | "[YYYY-mm-dd] CLOSE"                           |
| 用户查询书籍信息时输入 | "[YYYY-mm-dd] <学号> queried <类别号-序列号>"  |
| 用户借书时输入         | "[YYYY-mm-dd] <学号> borrowed <类别号-序列号>" |
| 用户预约时输入         | "[YYYY-mm-dd] <学号> ordered <类别号-序列号>"  |
| 用户还书时输入         | "[YYYY-mm-dd] <学号> returned <类别号-序列号>" |
| 用户取书时输入         | "[YYYY-mm-dd] <学号> picked <类别号-序列号>"   |

### 二、程序输出

当程序运行时发生表格中出现的场景时，要求输出相应信息。每条信息占一行。

**开馆时**：

| 场景                   | 输出                                                    |
| ---------------------- | ------------------------------------------------------- |
| 用户查询书籍信息时输出 | "[YYYY-mm-dd] <类别号-序列号> <可借阅余本数>"           |
| 用户借书成功时输出     | "[YYYY-mm-dd] [accept] <学号> borrowed <类别号-序列号>" |
| 用户借书失败时输出     | "[YYYY-mm-dd] [reject] <学号> borrowed <类别号-序列号>" |
| 用户预约成功时输出     | "[YYYY-mm-dd] [accept] <学号> ordered <类别号-序列号>"  |
| 用户预约失败时输出     | "[YYYY-mm-dd] [reject] <学号> ordered <类别号-序列号>"  |
| 用户还书成功时输出     | "[YYYY-mm-dd] [accept] <学号> returned <类别号-序列号>" |
| 用户取书成功时输出     | "[YYYY-mm-dd] [accept] <学号> picked <类别号-序列号>"   |
| 用户取书失败时输出     | "[YYYY-mm-dd] [reject] <学号> picked <类别号-序列号>"   |

要求输出按照时间先后顺序排序。也即同一日期的全部信息，输出的顺序应与事件发生的先后顺序相同。

某日处理开馆后请求的输出，只应出现在当日开馆后，当日闭馆前。

**整理时**：

接收到开馆指令OPEN和闭馆指令CLOSE以后，需要输出一个整数k作为准备进行的书籍移动次数，接下来输出k行，每行一条图书移动信息。

本次作业中，我们规定书籍移动的起点和终点只能为如下三种：

- bookshelf (简写作 bs) ：书架
- borrow and return office (简写作 bro) ：借还处
- appointment office (简写作 ao) ：预约处

**注意：起点和终点不能相同**

| 场景                     | 输出                                                         |
| ------------------------ | ------------------------------------------------------------ |
| 图书移动，终点不为预约处 | "[YYYY-mm-dd] move <类别号-序列号> from <起点> to <终点>"    |
| 图书移动，终点为预约处   | "[YYYY-mm-dd] move <类别号-序列号> from <起点> to <终点> for <学号>" |

图书转运路径的输出，应当紧接在开馆后和闭馆后。

### 三、样例

| 输入                                                         | 输出                                                         | 说明                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ---------------------------------------- |
| 3<br/>A-0000 3<br/>B-0000 3<br/>C-0000 2<br/>[2024-01-05] OPEN<br/>[2024-01-05] 22370001 borrowed A-0000<br/>[2024-01-05] 22370002 borrowed B-0000<br/>[2024-01-05] 22370003 borrowed C-0000<br/>[2024-01-05] CLOSE<br/>[2024-01-06] OPEN<br/>[2024-01-06] 22370002 returned B-0000<br/>[2024-01-06] 22370003 returned C-0000<br/>[2024-01-06] CLOSE | 0<br/>[2024-01-05] [reject] 22370001 borrowed A-0000<br/>[2024-01-05] [accept] 22370002 borrowed B-0000<br/>[2024-01-05] [accept] 22370003 borrowed C-0000<br/>0<br/>0<br/>[2024-01-06] [accept] 22370002 returned B-0000<br/>[2024-01-06] [accept] 22370003 returned C-0000<br/>2<br/>[2024-01-06] move B-0000 from bro to bs<br/>[2024-01-06] move C-0000 from bro to bs | 展示了借阅三类图书的情况和闭馆后图书转运 |
| 1<br/>B-0000 1<br/>[2024-01-05] OPEN<br/>[2024-01-05] 22370001 ordered B-0000<br/>[2024-01-05] CLOSE<br/>[2024-01-06] OPEN<br/>[2024-01-06] 22370001 picked B-0000<br/>[2024-01-06] CLOSE<br/>[2024-01-07] OPEN<br/>[2024-01-07] 22370001 picked B-0000<br/>[2024-01-07] CLOSE | 0<br/>[2024-01-05] [accept] 22370001 ordered B-0000<br/>0<br/>0<br/>[2024-01-06] [reject] 22370001 picked B-0000<br/>1<br/>[2024-01-06] move B-0000 from bs to ao for 21370001<br/>0<br/>[2024-01-07] [accept] 22370001 picked B-0000<br/>0 | 展示了预定书籍和取书的情况               |

## 第六部分：提示与警示

### 一、提示

同学们可以使用课程组提供的官方包完成输入输出解析，格式化输出等功能。官方包的公开方法均写有Java Doc注释，可以在IDEA中查看。官方包详细使用说明敬见讨论区。

### 二、警示

对于交互式评测，使用官方包时，一次读入方法，必须调用且仅调用一次输出方法。

图书的整理流程会影响到此后开馆时服务的成功率，同学们设计的图书馆管理系统可以自行安排整理环节中图书的搬运操作，但我们禁止出现“摆烂式图书馆”，即从不整理图书，导致借阅与预约请求全部失败，且完全不处理预约请求。

具体的，我们规定在中测和强测中有如下限制：
$$
\frac{所有对B类图书的借阅成功次数}{对B类图书借阅总数}，\frac{对所有B类图书取书成功次数}{对B类图书预约总数}，\frac{所有对C类图书的借阅成功次数}{对C类图书借阅总数}，\frac{对所有C类图书取书成功次数}{对C类图书预约总数}
$$
以上四个比例不得低于标程的50%。

本单元聚焦于UML正向建模与设计，且不安排互测，也没有性能分。同学们无需刻意考虑各种边界情况，只需自行设计合理的图书整理策略与系统运行逻辑，不存在明显不合常理的行为（如把所有书籍整理到借还处而拒绝借给任何同学），即可通过评测。

